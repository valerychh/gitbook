# mdadm

На этой странице рассматриваются вопросы создания и обслуживания программного RAID-массива в операционной системе Linux.

  
Управление программным RAID-массивом в Linux выполняется с помощью утилиты **mdadm**.  
У программы **mdadm** есть несколько режимов работы:

**Assemble** \(сборка\)   
Собрать компоненты ранее созданного массива в массив. Компоненты можно указывать явно, но можно и не указывать — тогда выполняется их поиск по суперблокам.   
**Build** \(построение\) Собрать массив из компонентов, у которых нет суперблоков. Не выполняются никакие проверки, создание и сборка массива в принципе ничем не отличаются.   
**Create** \(создание\) Создать новый массив на основе указанных устройств. Использовать суперблоки размещённые на каждом устройстве.   
**Monitor** \(наблюдение\) Следить за изменением состояния устройств. Для RAID0 этот режим не имеет смысла.   
**Grow** \(расширение или уменьшение\) Расширение или уменьшение массива, включаются или удаляются новые диски.   
**Incremental Assembly** \(инкрементальная сборка\) Добавление диска в массив.   
**Manage** \(управление\) Разнообразные операции по управлению массивом, такие как замена диска и пометка как сбойного.   
**Misc** \(разное\) Действия, которые не относятся ни к одному из перечисленных выше режимов работы.   
**Auto-detect** \(автоообнаружение\) Активация автоматически обнаруживаемых массивов в ядре Linux.

Формат вызова:

```bash
 mdadm [mode] [array] [options]
```

Режимы:

* -A, --assemble — режим сборки
* -B, --build — режим построения
* -C, --create — режим создания
* -F, --follow, --monitor — режим наблюдения
* -G, --grow — режим расширения
* -I, --incremental — режим инкрементальной сборки

### Настройка программного RAID-массива

Рассмотрим как выполнить настройку RAID-массива 5 уровня на трёх дисковых разделах. Мы будем использовать разделы:

```bash
/dev/hde1
/dev/hdf2
/dev/hdg1
```

В том случае если разделы иные, не забудьте использовать соответствующие имена файлов.

### Создание RAID-массива

Создание RAID-массива выполняется с помощью программы **mdadm** \(ключ --create\). Мы воспользуемся опцией --level, для того чтобы создать RAID-массив 5 уровня. С помощью ключа --raid-devices укажем устройства, поверх которых будет собираться RAID-массив.

```bash
$ mdadm --create --verbose /dev/md0 --level=5  --raid-devices=3 /dev/hde1 /dev/hdf2 /dev/hdg1

    mdadm: layout defaults to left-symmetric
    mdadm: chunk size defaults to 64K
    mdadm: /dev/hde1 appears to contain an ext2fs file system
        size=48160K  mtime=Sat Jan 27 23:11:39 2007
    mdadm: /dev/hdf2 appears to contain an ext2fs file system
        size=48160K  mtime=Sat Jan 27 23:11:39 2007
    mdadm: /dev/hdg1 appears to contain an ext2fs file system
        size=48160K  mtime=Sat Jan 27 23:11:39 2007
    mdadm: size set to 48064K
    Continue creating array? y
    mdadm: array /dev/md0 started.
```

Если вы хотите сразу создать массив, где диска не хватает \(degraded\) просто укажите слово missing вместо имени устройства. Для RAID5 это может быть только один диск; для RAID6 — не более двух; для RAID1 — сколько угодно, но должен быть как минимум один рабочий.

### Проверка правильности сборки

Убедиться, что RAID-массив проинициализирован корректно можно просмотрев файл /proc/mdstat. В этом файле отражается текущее состояние RAID-массива.

```bash
$ cat /proc/mdstat
    Personalities : [raid5]
    read_ahead 1024 sectors
    md0 : active raid5 hdg1[2] hde1[1] hdf2[0]
        4120448 blocks level 5, 32k chunk, algorithm 3 [3/3] [UUU]

    unused devices: <none>
```

Обратите внимание на то, как называется новый RAID-массив. В нашем случае он называется /dev/md0. Мы будем обращаться к массиву по этому имени.

### Изменение /etc/fstab

Для того чтобы файловая система, созданная на новом RAID-массиве автоматически монтировалась при загрузке, добавим соответствующую запись в файл /etc/fstab хранящий список автоматически монтируемых при загрузке файловых систем.

```bash
/dev/md0      /raid     ext3    defaults    1 2
```

### Дальнейшая работа с массивом

Проверка состояния RAID-массива

```bash
$ raidstart /dev/md0
$ cat /proc/mdstat
    Personalities : [raid5]
    read_ahead 1024 sectors
    md0 : active raid5 hdg1[2] hde1[1] hdf2[0]
        4120448 blocks level 5, 32k chunk, algorithm 3 [3/3] [UUU]

    unused devices: <none>
```

Если в файле информация постоянно изменяется, например, идёт пересборка массива, то постоянно изменяющийся файл удобно просматривать при помощи программы **watch**:

```bash
watch cat /proc/mdstat
```

Как выполнить проверку целостности программного RAID-массива md0:

```bash
echo 'check' >/sys/block/md0/md/sync_action
```

Как посмотреть нашлись ли какие-то ошибки в процессе проверки программного RAID-массива по команде check или repair:

```bash
cat /sys/block/md0/md/mismatch_cnt
```

#### Пометка диска как сбойного

Диск в массиве можно условно сделать сбойным, ключ --fail \(-f\):

```bash
mdadm /dev/md0 -f     /dev/hde1
```

#### Удаление сбойного диска

Сбойный диск можно удалить с помощью ключа --remove \(-r\):

```bash
mdadm /dev/md0 -r       /dev/hde1
```

#### Добавление нового диска

Добавить новый диск в массив можно с помощью ключей --add \(-a\) и --re-add:

```bash
mdadm /dev/md0 -a    /dev/hde1
```

#### Сборка существующего массива

Собрать существующий массив можно с помощью **mdadm** --assemble. Как дополнительный аргумент указывается, нужно ли выполнять сканирование устройств, и если нет, то какие устройства нужно собирать.

```bash
$ mdadm --assemble /dev/md0 /dev/hde1 /dev/hdf2 /dev/hdg1
$ mdadm --assemble --scan
```

#### Расширение массива

Расширить массив можно с помощью ключа --grow \(-G\). Сначала добавляется диск, а потом массив расширяется:

```bash
mdadm /dev/md0 --add /dev/hdh2
```

Проверяем, что диск \(раздел\) добавился:

```bash
$ mdadm --detail /dev/md0
$ cat /proc/mdstat
```

Если раздел действительно добавился, мы можем расширить массив:

```bash
mdadm -G /dev/md0 --raid-devices=4
```

Опция --raid-devices указывает новое количество дисков используемое в массиве. Например, было 3 диска, а теперь расширяем до 4-х - указываем 4.

Рекомендуется задать файл бэкапа на случай прерывания перестроения массива, например добавить:

```bash
--backup-file=/var/backup
```

При необходимости, можно регулировать скорость процесса расширения массива, указав нужное значение в файлах

```bash
/proc/sys/dev/raid/speed_limit_min
/proc/sys/dev/raid/speed_limit_max
```

Убедитесь, что массив расширился:

```bash
cat /proc/mdstat
```

#### Удаление массива

Для начала отмонтируйте и остановите массив:

```bash
$ umount /dev/md0
$ mdadm -S /dev/md0
```

Затем необходимо затереть superblock каждого из составляющих массива:

```bash
$ mdadm --zero-superblock /dev/hde1
$ mdadm --zero-superblock /dev/hdf2
```

Если действие выше не помогло, то затираем так:

```bash
$ dd if=/dev/zero of=/dev/hde1 bs=512 count=1
$ dd if=/dev/zero of=/dev/hdf2 bs=512 count=1
```

